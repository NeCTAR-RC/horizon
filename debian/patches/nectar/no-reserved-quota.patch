From 6ea49c1ebaf4d30fe2e01a690a5cc7e2339c7e5f Mon Sep 17 00:00:00 2001
From: Kieran Spear <kispear@gmail.com>
Date: Mon, 19 Aug 2013 10:45:42 +1000
Subject: [PATCH] Don't include reserved in quota calculation

---
 openstack_dashboard/api/nova.py                  |    3 +++
 openstack_dashboard/test/api_tests/nova_tests.py |    2 +-
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/openstack_dashboard/api/nova.py b/openstack_dashboard/api/nova.py
index af9a457..464ceab 100644
--- a/openstack_dashboard/api/nova.py
+++ b/openstack_dashboard/api/nova.py
@@ -544,9 +544,12 @@ def instance_volumes_list(request, instance_id):
 
 
 def tenant_absolute_limits(request, reserved=False):
+    reserved = False
     limits = novaclient(request).limits.get(reserved=reserved).absolute
     limits_dict = {}
     for limit in limits:
+        if limit.name.endswith('Used') and limit.value < 0:
+            limit.value = 0
         # -1 is used to represent unlimited quotas
         if limit.value == -1:
             limits_dict[limit.name] = float("inf")
diff --git a/openstack_dashboard/test/api_tests/nova_tests.py b/openstack_dashboard/test/api_tests/nova_tests.py
index f66aeb5..1838a8c 100644
--- a/openstack_dashboard/test/api_tests/nova_tests.py
+++ b/openstack_dashboard/test/api_tests/nova_tests.py
@@ -166,7 +166,7 @@ class ComputeApiTests(test.APITestCase):
         novaclient.limits.get(reserved=True).AndReturn(limits)
         self.mox.ReplayAll()
 
-        ret_val = api.nova.tenant_absolute_limits(self.request, reserved=True)
+        ret_val = api.nova.tenant_absolute_limits(self.request, reserved=False)
         expected_results = {"maxTotalCores": float("inf"),
                             "maxTotalInstances": 10}
         for key in expected_results.keys():
-- 
1.7.9.5

